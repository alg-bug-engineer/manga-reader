# ğŸ“Š Manga-Reader æ•°æ®å­˜å‚¨æ¶æ„è¯´æ˜

## ğŸ—‚ï¸ æ•°æ®å­˜å‚¨ä½ç½®

æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `data/` æ–‡ä»¶å¤¹ï¼š

```
/Users/zql_minii/ai-project/manga-reader/data/
â”œâ”€â”€ users.json       # ç”¨æˆ·è´¦å·ä¿¡æ¯
â”œâ”€â”€ sessions.json    # ç™»å½•ä¼šè¯ä¿¡æ¯
â”œâ”€â”€ favorites.json   # ç”¨æˆ·æ”¶è—æ•°æ®
â”œâ”€â”€ likes.json       # æ¼«ç”»ç‚¹èµæ•°æ®
â”œâ”€â”€ views.json       # æ¼«ç”»æµè§ˆé‡
â””â”€â”€ comments.json    # è¯„è®ºæ•°æ®
```

---

## ğŸ“‹ è¯¦ç»†æ•°æ®ç»“æ„

### 1. users.json - ç”¨æˆ·ä¿¡æ¯
```json
[
  {
    "id": "user-1735581234567",
    "email": "zhangsan@example.com",
    "username": "å¼ ä¸‰",
    "password": "plain_text_password",
    "createdAt": "2025-12-30T10:30:00.000Z"
  },
  {
    "id": "user-1735582345678",
    "email": "lisi@example.com",
    "username": "æå››",
    "password": "plain_text_password",
    "createdAt": "2025-12-30T11:20:00.000Z"
  }
]
```

**è¯´æ˜ï¼š**
- å­˜å‚¨æ‰€æœ‰æ³¨å†Œç”¨æˆ·çš„ä¿¡æ¯
- æ•°ç»„ç»“æ„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡
- å¯†ç ç›®å‰æ˜¯æ˜æ–‡ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦hashï¼‰

**ç®¡ç†å‡½æ•°ï¼š** (`lib/storage.ts`)
- `readUsers()` - è¯»å–æ‰€æœ‰ç”¨æˆ·
- `saveUsers(users)` - ä¿å­˜ç”¨æˆ·æ•°æ®
- `addUser(user)` - æ·»åŠ æ–°ç”¨æˆ·
- `findUserByEmail(email)` - æ ¹æ®é‚®ç®±æŸ¥æ‰¾
- `findUserById(id)` - æ ¹æ®IDæŸ¥æ‰¾

---

### 2. sessions.json - ä¼šè¯ç®¡ç†
```json
{
  "session-abc123xyz": {
    "sessionId": "session-abc123xyz",
    "userId": "user-1735581234567",
    "expiresAt": 1736185600000
  },
  "session-def456uvw": {
    "sessionId": "session-def456uvw",
    "userId": "user-1735582345678",
    "expiresAt": 1736186200000
  }
}
```

**è¯´æ˜ï¼š**
- å­˜å‚¨ç”¨æˆ·ç™»å½•ä¼šè¯
- sessionId - å”¯ä¸€ä¼šè¯IDï¼ˆå­˜å‚¨åœ¨cookieä¸­ï¼‰
- userId - å¯¹åº”çš„ç”¨æˆ·ID
- expiresAt - è¿‡æœŸæ—¶é—´æˆ³ï¼ˆ7å¤©åè¿‡æœŸï¼‰
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯

**ç®¡ç†å‡½æ•°ï¼š** (`lib/storage.ts`)
- `readSessionsData()` - è¯»å–ä¼šè¯æ•°æ®
- `saveSessionsData(data)` - ä¿å­˜ä¼šè¯æ•°æ®
- `createSession(userId, sessionId)` - åˆ›å»ºæ–°ä¼šè¯
- `getSessionUserId(sessionId)` - è·å–ç”¨æˆ·ID
- `deleteSession(sessionId)` - åˆ é™¤ä¼šè¯

---

### 3. favorites.json - æ”¶è—æ•°æ®
```json
{
  "user-1735581234567": ["manga-1", "manga-3", "manga-5"],
  "user-1735582345678": ["manga-2", "manga-4"]
}
```

**è¯´æ˜ï¼š**
- keyæ˜¯userIdï¼Œvalueæ˜¯è¯¥ç”¨æˆ·æ”¶è—çš„æ¼«ç”»IDæ•°ç»„
- ç®€å•é«˜æ•ˆçš„ç»“æ„
- æ”¯æŒå¿«é€ŸæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æ”¶è—

**ç®¡ç†å‡½æ•°ï¼š** (`lib/storage.ts`)
- `readFavoritesData()` - è¯»å–æ”¶è—æ•°æ®
- `saveFavoritesData(data)` - ä¿å­˜æ”¶è—æ•°æ®
- `getUserFavorites(userId)` - è·å–ç”¨æˆ·æ”¶è—åˆ—è¡¨
- `isFavorited(userId, mangaId)` - æ£€æŸ¥æ˜¯å¦æ”¶è—
- `addFavorite(userId, mangaId)` - æ·»åŠ æ”¶è—
- `removeFavorite(userId, mangaId)` - å–æ¶ˆæ”¶è—
- `toggleFavorite(userId, mangaId)` - åˆ‡æ¢æ”¶è—çŠ¶æ€

---

### 4. likes.json - ç‚¹èµæ•°æ® â­æ–°å¢
```json
{
  "userLikes": {
    "user-1735581234567": ["manga-1", "manga-2"],
    "user-1735582345678": ["manga-1", "manga-3", "manga-5"]
  },
  "counts": {
    "manga-1": 2,
    "manga-2": 1,
    "manga-3": 1,
    "manga-5": 1
  }
}
```

**è¯´æ˜ï¼š**
- `userLikes` - è®°å½•æ¯ä¸ªç”¨æˆ·ç‚¹èµäº†å“ªäº›æ¼«ç”»
  - key: userId
  - value: mangaIdæ•°ç»„
- `counts` - è®°å½•æ¯ä¸ªæ¼«ç”»çš„æ€»ç‚¹èµæ•°
  - key: mangaId
  - value: ç‚¹èµæ•°

**æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼š**
- ç”¨æˆ·ç‚¹èµæ—¶ï¼ŒåŒæ—¶æ›´æ–°userLikeså’Œcounts
- å–æ¶ˆç‚¹èµæ—¶ï¼ŒåŒæ—¶ä»userLikesåˆ é™¤å¹¶å‡å°‘counts
- é˜²æ­¢é‡å¤ç‚¹èµï¼ˆæ£€æŸ¥userLikesï¼‰

**ç®¡ç†å‡½æ•°ï¼š** (`lib/storage.ts`)
- `readLikesData()` - è¯»å–ç‚¹èµæ•°æ®
- `saveLikesData(data)` - ä¿å­˜ç‚¹èµæ•°æ®
- `hasUserLiked(userId, mangaId)` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹èµ
- `getMangaLikes(mangaId)` - è·å–æ¼«ç”»ç‚¹èµæ•°
- `getUserLikedMangas(userId)` - è·å–ç”¨æˆ·ç‚¹èµçš„æ¼«ç”»åˆ—è¡¨
- `toggleMangaLike(userId, mangaId)` - åˆ‡æ¢ç‚¹èµçŠ¶æ€
- `getAllMangaLikes()` - è·å–æ‰€æœ‰æ¼«ç”»ç‚¹èµæ•°æ®

---

### 5. views.json - æµè§ˆé‡
```json
{
  "manga-1": 18,
  "manga-2": 3,
  "manga-3": 7,
  "manga-5": 12
}
```

**è¯´æ˜ï¼š**
- è®°å½•æ¯ä¸ªæ¼«ç”»çš„æµè§ˆæ¬¡æ•°
- ç”¨æˆ·è®¿é—®æ¼«ç”»è¯¦æƒ…é¡µæ—¶è‡ªåŠ¨+1
- ç”¨äºäººæ°”æ’åºå’Œç»Ÿè®¡

**ç®¡ç†å‡½æ•°ï¼š** (`lib/scanner.ts`)
- `getViewsData()` - è¯»å–æµè§ˆé‡æ•°æ®

**APIï¼š**
- `POST /api/manga/[id]/view` - å¢åŠ æµè§ˆé‡

---

### 6. comments.json - è¯„è®ºæ•°æ®
```json
{
  "comment-abc123": {
    "id": "comment-abc123",
    "mangaId": "manga-1",
    "content": "è¿™ä¸ªæ¼«ç”»å¾ˆæœ‰è¶£ï¼",
    "userId": "user-1735581234567",
    "username": "å¼ ä¸‰",
    "likes": 5,
    "createdAt": "2025-12-30T10:35:00.000Z"
  }
}
```

**è¯´æ˜ï¼š**
- å­˜å‚¨æ‰€æœ‰è¯„è®º
- æ”¯æŒè¯„è®ºç‚¹èµåŠŸèƒ½

**APIï¼š**
- `GET /api/comments?mangaId=xxx` - è·å–è¯„è®ºåˆ—è¡¨
- `POST /api/comments` - å‘è¡¨è¯„è®º
- `POST /api/comments/[id]/like` - ç‚¹èµè¯„è®º

---

## ğŸ”„ æ•°æ®æµè½¬ç¤ºä¾‹

### ç”¨æˆ·ç™»å½•æµç¨‹
```
1. ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
   â†“
2. POST /api/auth/login
   â†“
3. éªŒè¯ç”¨æˆ·åå¯†ç  (users.json)
   â†“
4. ç”ŸæˆsessionId
   â†“
5. åˆ›å»ºsession (sessions.json)
   â†“
6. è®¾ç½®cookie (sessionId)
   â†“
7. è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### ç”¨æˆ·ç‚¹èµæµç¨‹
```
1. ç”¨æˆ·ç‚¹å‡»ç‚¹èµæŒ‰é’®
   â†“
2. POST /api/manga/[id]/like
   â†“
3. ä»cookieè·å–sessionId
   â†“
4. è·å–userId (sessions.json)
   â†“
5. æ£€æŸ¥å½“å‰ç‚¹èµçŠ¶æ€
   â†“
6. æ›´æ–°ç‚¹èµæ•°æ® (likes.json)
   - userLikes[userId].push(mangaId)
   - counts[mangaId]++
   â†“
7. è¿”å›æ–°çš„ç‚¹èµçŠ¶æ€å’Œæ•°é‡
```

### äººæ°”æ¨èæ’åº
```
1. åŠ è½½æ‰€æœ‰æ¼«ç”»æ•°æ®
   â†“
2. æ¯ä¸ªæ¼«ç”»åŒ…å« likes å­—æ®µ
   â†“
3. æŒ‰ likes é™åºæ’åº
   â†“
4. å–å‰5ä¸ª
   â†“
5. æ˜¾ç¤ºåœ¨"äººæ°”æ¨è"åŒºå—
```

---

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–æœºåˆ¶

### å†™å…¥æ—¶æœº
- **ç”¨æˆ·æ“ä½œæ—¶ç«‹å³å†™å…¥** - ç‚¹èµã€æ”¶è—ã€è¯„è®ºç­‰
- **åŸå­æ“ä½œ** - æ¯æ¬¡æ“ä½œéƒ½å®Œæ•´å†™å…¥æ–‡ä»¶
- **åŒæ­¥ä¿å­˜** - ä½¿ç”¨ `fs.writeFileSync` åŒæ­¥å†™å…¥

### è¯»å–æ—¶æœº
- **æŒ‰éœ€è¯»å–** - APIè¯·æ±‚æ—¶è¯»å–å¯¹åº”æ–‡ä»¶
- **ç¼“å­˜é¿å…** - ä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½è¯»æœ€æ–°æ•°æ®

### æ•°æ®ä¸€è‡´æ€§
- **äº‹åŠ¡æ€§** - æ¯ä¸ªæ“ä½œéƒ½æ˜¯å®Œæ•´çš„ï¼ˆå¦‚ç‚¹èµåŒæ—¶æ›´æ–°userLikeså’Œcountsï¼‰
- **é”™è¯¯å¤„ç†** - try-catchåŒ…è£¹ï¼Œå¤±è´¥æ—¶ä¸ä¿å­˜
- **é»˜è®¤å€¼** - æ–‡ä»¶ä¸å­˜åœ¨æ—¶è¿”å›ç©ºå¯¹è±¡/æ•°ç»„

---

## âš ï¸ å½“å‰æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹

### âœ… ä¼˜ç‚¹
1. **ç®€å•æ˜“æ‡‚** - JSONæ ¼å¼ç›´è§‚ï¼Œæ˜“äºè°ƒè¯•
2. **é›¶é…ç½®** - æ— éœ€å®‰è£…æ•°æ®åº“
3. **æ˜“äºå¤‡ä»½** - ç›´æ¥å¤åˆ¶dataæ–‡ä»¶å¤¹
4. **é€‚åˆå°å‹åº”ç”¨** - < 1000ç”¨æˆ·å®Œå…¨å¤Ÿç”¨
5. **å¼€å‘å‹å¥½** - å¯ä»¥ç›´æ¥æŸ¥çœ‹å’Œç¼–è¾‘æ•°æ®

### âŒ ç¼ºç‚¹
1. **å¹¶å‘æ€§èƒ½å·®** - æ–‡ä»¶é”å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜
2. **æŸ¥è¯¢æ•ˆç‡ä½** - éœ€è¦å…¨éƒ¨è¯»å–åå†ç­›é€‰
3. **ä¸æ”¯æŒå¤æ‚æŸ¥è¯¢** - æ— æ³•JOINã€èšåˆç­‰
4. **æ— äº‹åŠ¡æ”¯æŒ** - å¤æ‚æ“ä½œå¯èƒ½æ•°æ®ä¸ä¸€è‡´
5. **æ‰©å±•æ€§å·®** - å¤§é‡æ•°æ®æ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾

---

## ğŸš€ å‡çº§å»ºè®®

### å½“å‰é˜¶æ®µï¼ˆ< 1000ç”¨æˆ·ï¼‰
âœ… **ç»§ç»­ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨**
- å®Œå…¨å¤Ÿç”¨
- ç»´æŠ¤ç®€å•
- æˆæœ¬ä¸ºé›¶

### æˆé•¿æœŸï¼ˆ1000-10000ç”¨æˆ·ï¼‰
âš ï¸ **å»ºè®®å‡çº§åˆ° SQLite + Prisma**
- é›¶é…ç½®
- æ€§èƒ½ä¼˜ç§€
- æ”¯æŒç´¢å¼•
- SQLæŸ¥è¯¢

### æˆç†ŸæœŸï¼ˆ> 10000ç”¨æˆ·ï¼‰
ğŸ”¥ **å»ºè®®å‡çº§åˆ° PostgreSQL + Docker**
- é«˜å¹¶å‘æ”¯æŒ
- äº‹åŠ¡ä¿è¯
- è¯»å†™åˆ†ç¦»
- æ°´å¹³æ‰©å±•

---

## ğŸ“Š æ•°æ®é‡é¢„ä¼°

å‡è®¾ï¼š
- 1000ä¸ªç”¨æˆ·
- æ¯ä¸ªç”¨æˆ·æ”¶è—50ä¸ªæ¼«ç”» = 50,000æ¡æ”¶è—è®°å½•
- æ¯ä¸ªç”¨æˆ·ç‚¹èµ30ä¸ªæ¼«ç”» = 30,000æ¡ç‚¹èµè®°å½•
- æ¯ä¸ªæ¼«ç”»500ä¸ªæµè§ˆé‡
- æ¯ä¸ªæ¼«ç”»100æ¡è¯„è®º

**JSONæ–‡ä»¶å¤§å°ä¼°ç®—ï¼š**
- users.json: ~50KB
- sessions.json: ~100KB (è‡ªåŠ¨æ¸…ç†è¿‡æœŸ)
- favorites.json: ~500KB
- likes.json: ~300KB
- views.json: ~10KB
- comments.json: ~2MB

**æ€»è®¡: ~3MB**

æ€§èƒ½å½±å“ï¼š**å¯å¿½ç•¥** âœ…

---

## ğŸ”§ å¼€å‘ç›¸å…³

### æ·»åŠ æ–°çš„æ•°æ®å­—æ®µ
1. åœ¨ `types/manga.ts` ä¸­å®šä¹‰æ¥å£
2. åœ¨ `lib/scanner.ts` çš„ `convertToManga` ä¸­åˆå§‹åŒ–
3. åœ¨ `lib/hooks/useMangaData.ts` ä¸­æ˜ å°„åˆ°åˆ—è¡¨
4. åˆ›å»ºAPIè·¯ç”±è¿›è¡Œè¯»å†™

### ç¤ºä¾‹ï¼šæ·»åŠ è¯„åˆ†åŠŸèƒ½
```typescript
// 1. å®šä¹‰ç±»å‹
interface Rating {
  userId: string;
  mangaId: string;
  score: number; // 1-5
}

// 2. å­˜å‚¨ç»“æ„
{
  "ratings": [
    { "userId": "user-1", "mangaId": "manga-1", "score": 5 }
  ],
  "averages": {
    "manga-1": 4.5
  }
}
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ‰‹åŠ¨ä¿®æ”¹ data/*.json** - å¯èƒ½å¯¼è‡´æ ¼å¼é”™è¯¯
2. **å®šæœŸå¤‡ä»½ data æ–‡ä»¶å¤¹** - é˜²æ­¢æ•°æ®ä¸¢å¤±
3. **ç”Ÿäº§ç¯å¢ƒéœ€è¦å¯†ç hash** - ä½¿ç”¨bcrypt
4. **æ•æ„Ÿæ•°æ®åŠ å¯†** - è€ƒè™‘ä½¿ç”¨åŠ å¯†ç®—æ³•
5. **è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™** - é¿å…å®‰å…¨æ¼æ´

---

## ğŸ¯ æ€»ç»“

å½“å‰ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨æ˜¯**å®Œå…¨åˆç†çš„é€‰æ‹©**ï¼š

âœ… é€‚åˆå°å‹é¡¹ç›®å’ŒåŸå‹å¼€å‘
âœ… ä»£ç ç®€å•æ˜“æ‡‚
âœ… é›¶è¿ç»´æˆæœ¬
âœ… æ–¹ä¾¿è°ƒè¯•å’Œæµ‹è¯•

**ä½•æ—¶éœ€è¦å‡çº§ï¼š**
- ç”¨æˆ·æ•° > 1000
- éœ€è¦å¤æ‚æŸ¥è¯¢
- éœ€è¦é«˜å¹¶å‘
- éœ€è¦äº‹åŠ¡æ”¯æŒ

å‚è€ƒ `DATA_MIGRATION_GUIDE.md` äº†è§£å¦‚ä½•å‡çº§åˆ°æ•°æ®åº“ï¼
