# Gemini ä»£ç†æœåŠ¡å™¨è°ƒè¯•æŒ‡å—

## é¡¹ç›®æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨ Node.js (Next.js) + Python (Flask) çš„åˆ†ç¦»æ¶æ„ï¼š

```
[ç”¨æˆ·æµè§ˆå™¨]
    â†“
[Next.js Web åº”ç”¨ (Node.js)]
    â†“
[Python ä»£ç†æœåŠ¡å™¨ (Flask)]
    â†“
[Gemini API]
```

## å¿«é€Ÿæµ‹è¯•

### 1. å¯åŠ¨ Python æœåŠ¡å™¨

```bash
cd /Users/zql_minii/ai-project/manga-reader
./start-proxy-server.sh
```

æœåŠ¡å™¨å°†åœ¨ `http://127.0.0.1:3001` å¯åŠ¨

### 2. ä½¿ç”¨ uv ç¯å¢ƒæµ‹è¯•æœåŠ¡å™¨

åœ¨**æ–°ç»ˆç«¯**ä¸­è¿è¡Œï¼š

```bash
cd /Users/zql_minii/ai-project/manga-reader

# æ¿€æ´» uv è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_server.py
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
1. âœ… å¥åº·æ£€æŸ¥
2. âœ… è„šæœ¬ç”Ÿæˆæµ‹è¯•
3. âœ… å›¾ç‰‡ç”Ÿæˆæµ‹è¯•

### 3. å¯åŠ¨ Next.js å¼€å‘æœåŠ¡å™¨

åœ¨**ç¬¬ä¸‰ä¸ªç»ˆç«¯**ä¸­è¿è¡Œï¼š

```bash
cd /Users/zql_minii/ai-project/manga-reader
npm run dev
```

è®¿é—® `http://localhost:3000` ä½¿ç”¨ Web åº”ç”¨

## è°ƒè¯•æµç¨‹

### æ£€æŸ¥ç‚¹ 1: Python æœåŠ¡å™¨çŠ¶æ€

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://127.0.0.1:3001/health

# é¢„æœŸå“åº”
{
  "status": "ok",
  "client_initialized": true,
  "has_api_key": true
}
```

### æ£€æŸ¥ç‚¹ 2: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

ç°åœ¨æ‰€æœ‰ç»„ä»¶éƒ½æ·»åŠ äº†è¯¦ç»†æ—¥å¿—ï¼Œå¯ä»¥æ¸…æ™°è¿½è¸ªæ•´ä¸ªè¯·æ±‚æµç¨‹ï¼š

#### Python æœåŠ¡å™¨æ—¥å¿— (gemini_proxy_server.py)

```
============================================================
ğŸ“ [API] /api/generate-script è¯·æ±‚
============================================================
ğŸ“ æ¦‚å¿µ: Transformer
ğŸ¤– æ¨¡å‹: gemini-2.0-flash-exp
â° æ—¶é—´: 2025-12-31 10:30:00
ğŸ“¤ å‘é€è¯·æ±‚åˆ° Gemini API...
ğŸ“¥ æ”¶åˆ° Gemini API å“åº”
âœ… è„šæœ¬ç”ŸæˆæˆåŠŸ
ğŸ“Š ç”Ÿæˆæ–‡æœ¬é•¿åº¦: 3456 å­—ç¬¦
â° å®Œæˆæ—¶é—´: 2025-12-31 10:30:15
ğŸ” å°è¯•è§£æ JSON...
âœ… é€šè¿‡æ­£åˆ™æå– JSON
âœ… JSON è§£ææˆåŠŸ
ğŸ“Š è§£æé¢æ¿æ•°: 24 æ ¼
============================================================
```

#### Node.js ä»£ç†æœåŠ¡æ—¥å¿— (geminiServiceProxy.ts)

```
============================================================
[Proxy] â†’ è¯·æ±‚å¼€å§‹
[Proxy] â†’ ç«¯ç‚¹: /api/generate-script
[Proxy] â†’ æœåŠ¡å™¨: http://127.0.0.1:3001
[Proxy] â†’ è¶…æ—¶è®¾ç½®: 120ç§’
[Proxy] â†’ æ—¶é—´: 2025/12/31 10:30:00
[Proxy] â†’ è¯·æ±‚æ•°æ®: {
  "concept": "Transformer",
  "model": "gemini-2.0-flash-exp"
}
============================================================

============================================================
[Proxy] â† å“åº”æ¥æ”¶
[Proxy] â† HTTP çŠ¶æ€: 200 OK
[Proxy] â† è€—æ—¶: 15342ms
============================================================
```

#### Next.js API è·¯ç”±æ—¥å¿— (route.ts)

```
============================================================
[API] ğŸ“ /api/generate-comic/script è¯·æ±‚å¼€å§‹
[API] â° æ—¶é—´: 2025/12/31 10:30:00
============================================================

[API] ğŸ“¥ è¯·æ±‚å‚æ•°:
[API]    - concept: Transformer
[API]    - style: peach
[API] âœ… å‚æ•°éªŒè¯é€šè¿‡
[API] ğŸ“ è°ƒç”¨ generateComicScript...

============================================================
[API] âœ… è„šæœ¬ç”ŸæˆæˆåŠŸ
[API] ğŸ“Š è¿”å›é¢æ¿æ•°: 24
[API] â±ï¸  æ€»è€—æ—¶: 15345ms
============================================================
```

### æ£€æŸ¥ç‚¹ 3: å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1: æ— æ³•è¿æ¥åˆ° Python æœåŠ¡å™¨

**ç—‡çŠ¶**:
```
[Proxy] âŒ æ— æ³•è¿æ¥åˆ° Python ä»£ç†æœåŠ¡å™¨
[Proxy] ğŸ’¡ è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: ./start-proxy-server.sh
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
ps aux | grep gemini_proxy_server

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :3001

# 3. é‡å¯æœåŠ¡å™¨
./start-proxy-server.sh
```

#### é—®é¢˜ 2: API Key æœªè®¾ç½®

**ç—‡çŠ¶**:
```
âŒ GEMINI_API_KEY æœªè®¾ç½®ï¼
   è¯·æ£€æŸ¥ .env.local æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å« GEMINI_API_KEY
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ .env.local æ–‡ä»¶
cat /Users/zql_minii/ai-project/manga-reader/.env.local

# åº”è¯¥åŒ…å«:
# GEMINI_API_KEY=AIzaSyD_0if8ekrLBs3imMYPdkGjDyN08p5LUN4
```

#### é—®é¢˜ 3: è¯·æ±‚è¶…æ—¶

**ç—‡çŠ¶**:
```
[Proxy] âŒ è¯·æ±‚è¶…æ—¶ (120ç§’)
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping generativelanguage.googleapis.com

# æ£€æŸ¥ç³»ç»Ÿä»£ç†è®¾ç½®
echo $HTTP_PROXY
echo $HTTPS_PROXY

# å¯ä»¥åœ¨ .env.local ä¸­å¢åŠ è¶…æ—¶æ—¶é—´
# GEMINI_REQUEST_TIMEOUT=180000  # 180ç§’
```

#### é—®é¢˜ 4: JSON è§£æå¤±è´¥

**ç—‡çŠ¶**:
```
âŒ JSON è§£æå¤±è´¥: Expecting value
ğŸ“„ åŸå§‹å“åº”å‰500å­—ç¬¦: ...
```

**è§£å†³æ–¹æ¡ˆ**:
- æŸ¥çœ‹ Python æœåŠ¡å™¨æ—¥å¿—ä¸­çš„åŸå§‹å“åº”
- æ£€æŸ¥ Gemini API æ˜¯å¦è¿”å›äº†é JSON æ ¼å¼å†…å®¹
- å¯èƒ½æ˜¯ API Key é…é¢ä¸è¶³æˆ–æ¨¡å‹åç§°é”™è¯¯

## æ—¥å¿—çº§åˆ«è¯´æ˜

### Python æœåŠ¡å™¨æ—¥å¿—

- `âœ…` - æˆåŠŸæ“ä½œ
- `âŒ` - é”™è¯¯
- `âš ï¸` - è­¦å‘Š
- `ğŸ“` - è„šæœ¬ç”Ÿæˆç›¸å…³
- `ğŸ¨` - å›¾ç‰‡ç”Ÿæˆç›¸å…³
- `ğŸ“¤` - å‘é€è¯·æ±‚
- `ğŸ“¥` - æ¥æ”¶å“åº”
- `ğŸ”` - å¤„ç†ä¸­
- `â°` - æ—¶é—´ä¿¡æ¯
- `ğŸ“Š` - æ•°æ®ç»Ÿè®¡

### Node.js æ—¥å¿—

- `[Proxy]` - ä»£ç†æœåŠ¡ç›¸å…³
- `[API]` - Next.js API è·¯ç”±ç›¸å…³
- `â†’` - å‘å‡ºè¯·æ±‚
- `â†` - æ¥æ”¶å“åº”
- `âœ…` - æˆåŠŸ
- `âŒ` - é”™è¯¯

## æµ‹è¯•è„šæœ¬ä½¿ç”¨

### è¿è¡Œå®Œæ•´æµ‹è¯•

```bash
python test_server.py
```

### æµ‹è¯•è¾“å‡ºè¯´æ˜

```
ğŸ§ª Gemini API ä»£ç†æœåŠ¡å™¨æµ‹è¯•
============================================================

============================================================
  1ï¸âƒ£  å¥åº·æ£€æŸ¥æµ‹è¯•
============================================================

âœ… å¥åº·æ£€æŸ¥é€šè¿‡
   çŠ¶æ€: ok
   å®¢æˆ·ç«¯åˆå§‹åŒ–: True
   API Key å­˜åœ¨: True

============================================================
  2ï¸âƒ£  è„šæœ¬ç”Ÿæˆæµ‹è¯•
============================================================

ğŸ“ æµ‹è¯•æ¦‚å¿µ: Transformer
ğŸ“¡ å‘é€è¯·æ±‚åˆ° http://127.0.0.1:3001/api/generate-script
ğŸ“Š å“åº”çŠ¶æ€ç : 200
âœ… è„šæœ¬ç”ŸæˆæˆåŠŸ!
   æ€»æ ¼æ•°: 24
   è¿”å›é¢æ¿æ•°: 24

   ç¬¬ä¸€æ ¼é¢„è§ˆ:
   - åœºæ™¯: ä¸€ä¸ªå¯çˆ±çš„æœºå™¨äººæ‹¿ç€ä¸€æœ¬åšåšçš„ä¹¦ï¼Œç«™åœ¨è®²å°ä¸Š...
   - å¯¹è¯: æœºå™¨äººï¼šä»Šå¤©æˆ‘ä»¬è¦è®²çš„æ˜¯ Transformerï¼...

============================================================
  3ï¸âƒ£  å›¾ç‰‡ç”Ÿæˆæµ‹è¯•
============================================================

ğŸ¨ æµ‹è¯•é¢æ¿: ç¬¬ 1 æ ¼
ğŸ“¡ å‘é€è¯·æ±‚åˆ° http://127.0.0.1:3001/api/generate-image
ğŸ“Š å“åº”çŠ¶æ€ç : 200
âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸ!
   å›¾ç‰‡æ•°æ®å¤§å°: 45678 bytes
   (~44.6 KB)

============================================================
ğŸ“‹ æµ‹è¯•æ€»ç»“
============================================================
   å¥åº·æ£€æŸ¥: âœ… é€šè¿‡
   è„šæœ¬ç”Ÿæˆ: âœ… é€šè¿‡
   å›¾ç‰‡ç”Ÿæˆ: âœ… é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æœåŠ¡å™¨è¿è¡Œæ­£å¸¸
```

## é…ç½®æ–‡ä»¶

### .env.local

```bash
# Gemini API Configuration
GEMINI_API_KEY=ä½ çš„APIå¯†é’¥
GEMINI_SCRIPT_MODEL=gemini-2.0-flash-exp
GEMINI_IMAGE_MODEL=gemini-2.0-flash-exp

# API Rate Limiting (milliseconds between requests)
GEMINI_RATE_LIMIT_DELAY=10000

# Optional: Proxy Server URL (default: http://127.0.0.1:3001)
GEMINI_PROXY_SERVER=http://127.0.0.1:3001

# Optional: Request Timeout (default: 120000ms)
GEMINI_REQUEST_TIMEOUT=120000
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹**: `gemini-2.0-flash-exp` æ¯” `gemini-1.5-pro` æ›´å¿«
2. **è°ƒæ•´è¶…æ—¶æ—¶é—´**: æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´ `GEMINI_REQUEST_TIMEOUT`
3. **å¯ç”¨ç¼“å­˜**: å¯¹é‡å¤çš„æ¦‚å¿µå¯ä»¥ç¼“å­˜ç”Ÿæˆçš„è„šæœ¬
4. **æ‰¹é‡ç”Ÿæˆ**: ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªæ ¼å­çš„å›¾ç‰‡

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. âœ… è¿è¡Œ `python test_server.py` æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
2. âœ… æŸ¥çœ‹ Python æœåŠ¡å™¨ç»ˆç«¯æ—¥å¿—
3. âœ… æŸ¥çœ‹ Next.js å¼€å‘æœåŠ¡å™¨ç»ˆç«¯æ—¥å¿—
4. âœ… æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

## æ–‡ä»¶ä½ç½®

- Python æœåŠ¡å™¨: `/Users/zql_minii/ai-project/manga-reader/gemini_proxy_server.py`
- æµ‹è¯•è„šæœ¬: `/Users/zql_minii/ai-project/manga-reader/test_server.py`
- Node.js ä»£ç†: `/Users/zql_minii/ai-project/manga-reader/lib/services/geminiServiceProxy.ts`
- è„šæœ¬ API: `/Users/zql_minii/ai-project/manga-reader/app/api/generate-comic/script/route.ts`
- å›¾ç‰‡ API: `/Users/zql_minii/ai-project/manga-reader/app/api/generate-comic/image/route.ts`
- ç¯å¢ƒé…ç½®: `/Users/zql_minii/ai-project/manga-reader/.env.local`
